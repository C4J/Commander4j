<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE DDL SYSTEM "schema.dtd">
<DDL>
    
	<statement>
		ALTER TABLE [dbo].[APP_PROCESS_ORDER_RESOURCE] ADD [PLANT_ID] varchar(20) DEFAULT ''
	</statement>
	
	<statement>
		ALTER VIEW [dbo].[view_qm_results] AS SELECT samp.PROCESS_ORDER as 'PROCESS_ORDER',
		       samp.MATERIAL as 'MATERIAL',
		       samp.SAMPLE_ID as 'SAMPLE_ID',
		       samp.SAMPLE_DATE as 'SAMPLE_DATE',
		       samp.USER_DATA_1 as 'USER_DATA_1',
		       samp.USER_DATA_2 as 'USER_DATA_2',
		       samp.USER_DATA_3 as 'USER_DATA_3',
		       samp.USER_DATA_4 as 'USER_DATA_4',
		       result.TEST_ID as 'TEST_ID',
		       dict.DESCRIPTION as 'TEST_DESCRIPTION',
		       result.VALUE as 'VALUE',
		       COALESCE(valist.DESCRIPTION,result.VALUE) AS 'RESULT'
				FROM APP_QM_SAMPLE samp 
				LEFT JOIN APP_QM_RESULT result ON (result.SAMPLE_ID = samp.SAMPLE_ID)
				LEFT JOIN APP_QM_DICTIONARY dict ON (dict.TEST_ID = result.TEST_ID)
				LEFT JOIN APP_QM_SELECTLIST valist ON (valist.SELECT_LIST_ID = dict.SELECT_LIST_ID AND valist.VALUE = result.VALUE)
</statement>

<statement>
		ALTER VIEW [dbo].[view_qm_panel_results] AS (SELECT
			APP_QM_SAMPLE.SAMPLE_DATE,  
			APP_QM_PANEL.PANEL_DATE,
			APP_QM_PANEL.STATUS,
			APP_QM_PANEL_TRAY.PANEL_ID,
			APP_QM_PANEL_TRAY.TRAY_ID,
			APP_QM_PANEL_TRAY.DESCRIPTION AS 'TRAY_DESCRIPTION',
			APP_QM_SAMPLE.SAMPLE_ID,
			APP_QM_SAMPLE.PROCESS_ORDER,
			APP_QM_SAMPLE.MATERIAL,
			PRODUCT_GROUP.DATA AS 'PRODUCT_GROUP',
			CONTAINER_CODE.DATA AS 'CONTAINER_CODE',
			APP_PROCESS_ORDER.REQUIRED_RESOURCE,
			APP_PROCESS_ORDER_RESOURCE.PLANT_ID AS 'PLANT',
			APP_QM_RESULT_FILLER.VALUE AS FILLER,
			APP_QM_RESULT_FILL_TIME.VALUE AS 'FILL_TIME',
			APP_QM_SAMPLE.USER_DATA_1,
			APP_QM_SAMPLE.USER_DATA_2,
			APP_QM_SAMPLE.USER_DATA_3,
			APP_QM_SAMPLE.USER_DATA_4,
			APP_QM_RESULT_PH.VALUE AS 'PH',
			APP_QM_RESULT_SHIFT.VALUE AS 'PANEL_SHIFT',
			APP_QM_PANEL_TRAY_RESULTS.USER_ID,
			APP_QM_PANEL_TRAY_RESULTS.VALUE AS 'VALUE',
			SELECTLIST1.DESCRIPTION AS 'RESULT_DESCRIPTION',
			APP_QM_USERS.FIRST_NAME,
			APP_QM_USERS.SURNAME,
			APP_PROCESS_ORDER_RESOURCE.BATCH_SUFFIX AS 'BATCH_SUFFIX',
			IIF(LEFT(SELECTLIST1.DESCRIPTION,4) LIKE 'INC %',1,0) AS 'INC',
			IIF(LEFT(SELECTLIST1.DESCRIPTION,4) LIKE 'IN',1,0) AS 'IN',
			IIF(LEFT(SELECTLIST1.DESCRIPTION,4) LIKE 'OUT %',1,0) AS 'OUT'
		FROM
			APP_QM_PANEL_TRAY_RESULTS
			LEFT JOIN APP_QM_SAMPLE ON APP_QM_SAMPLE.SAMPLE_ID = APP_QM_PANEL_TRAY_RESULTS.SAMPLE_ID
			INNER JOIN APP_QM_PANEL_TRAY ON APP_QM_PANEL_TRAY_RESULTS.TRAY_ID = APP_QM_PANEL_TRAY.TRAY_ID
			INNER JOIN APP_QM_PANEL ON APP_QM_PANEL.PANEL_ID = APP_QM_PANEL_TRAY.PANEL_ID
			LEFT JOIN APP_QM_USERS ON APP_QM_USERS.USER_ID = APP_QM_PANEL_TRAY_RESULTS.USER_ID	
			LEFT JOIN APP_QM_RESULT AS APP_QM_RESULT_PH ON APP_QM_RESULT_PH.SAMPLE_ID  = APP_QM_PANEL_TRAY_RESULTS.SAMPLE_ID AND APP_QM_RESULT_PH.TEST_ID = 'PANEL PH'
			LEFT JOIN APP_QM_RESULT AS APP_QM_RESULT_FILL_TIME ON APP_QM_RESULT_FILL_TIME.SAMPLE_ID = APP_QM_PANEL_TRAY_RESULTS.SAMPLE_ID 	AND APP_QM_RESULT_FILL_TIME.TEST_ID = 'Fill Time'
			LEFT JOIN APP_QM_RESULT AS APP_QM_RESULT_FILLER ON APP_QM_RESULT_FILLER.SAMPLE_ID = APP_QM_PANEL_TRAY_RESULTS.SAMPLE_ID 	AND APP_QM_RESULT_FILLER.TEST_ID = 'Filler'
			LEFT JOIN APP_QM_RESULT AS APP_QM_RESULT_SHIFT ON APP_QM_RESULT_SHIFT.SAMPLE_ID = APP_QM_PANEL_TRAY_RESULTS.SAMPLE_ID 	AND APP_QM_RESULT_SHIFT.TEST_ID = 'Shift'
			LEFT JOIN APP_QM_SELECTLIST AS SELECTLIST1 ON SELECTLIST1.VALUE = APP_QM_PANEL_TRAY_RESULTS.VALUE 	AND SELECTLIST1.SELECT_LIST_ID = 'ZWSIPANE'
			LEFT JOIN APP_PROCESS_ORDER ON APP_QM_SAMPLE.PROCESS_ORDER = APP_PROCESS_ORDER.PROCESS_ORDER
			LEFT JOIN APP_PROCESS_ORDER_RESOURCE ON APP_PROCESS_ORDER.REQUIRED_RESOURCE = APP_PROCESS_ORDER_RESOURCE.REQUIRED_RESOURCE
			LEFT JOIN APP_MATERIAL_CUSTOMER_DATA AS PRODUCT_GROUP ON APP_QM_SAMPLE.MATERIAL = PRODUCT_GROUP.MATERIAL 	AND PRODUCT_GROUP.CUSTOMER_ID = 'SELF' 	AND PRODUCT_GROUP.DATA_ID = 'PRODUCT_GROUP'
			LEFT JOIN APP_MATERIAL_CUSTOMER_DATA AS CONTAINER_CODE ON APP_QM_SAMPLE.MATERIAL = CONTAINER_CODE.MATERIAL 	AND CONTAINER_CODE.CUSTOMER_ID = 'SELF' 	AND CONTAINER_CODE.DATA_ID = 'CONTAINER_CODE')
</statement>

</DDL>
